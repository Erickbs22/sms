<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de SMS Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .description-cell {
            min-width: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .sms-badge {
            font-family: monospace;
            background-color: #eff6ff;
            color: #1d4ed8;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .tab-active {
            border-bottom: 3px solid #1d4ed8;
            color: #1d4ed8;
            font-weight: bold;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            transition: 0.2s;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-2 md:p-6 text-slate-900">
    <!-- Overlay de Carregamento -->
    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p id="loaderText" class="mt-4 text-slate-600 font-medium">A processar...</p>
        </div>
    </div>

    <!-- Modal de Erro de Permiss√µes (Regras Firestore) -->
    <div id="permissionsErrorModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-80 z-[4000] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full mx-auto max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex items-center gap-3 mb-4 text-amber-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h2 class="text-2xl font-bold text-slate-800">Aten√ß√£o: Acesso Negado no Firebase!</h2>
            </div>
            <p class="text-slate-600 mb-4 text-sm leading-relaxed">
                O erro <strong>"Missing or insufficient permissions"</strong> que viu na consola significa que a aplica√ß√£o conseguiu encontrar o seu projeto, mas <strong>o seu pr√≥prio Firebase est√° a bloquear a entrada</strong> por seguran√ßa.
            </p>
            <p class="text-slate-600 mb-4 text-sm leading-relaxed">
                Enquanto n√£o corrigir as regras, a aplica√ß√£o ir√° funcionar em <strong>Modo Local</strong> (os dados n√£o v√£o para a nuvem). Para ativar a nuvem, siga estes passos:
            </p>
            
            <ol class="list-decimal list-inside text-sm text-slate-700 space-y-2 mb-4 ml-2 font-medium">
                <li>Aceda ao <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Console do Firebase</a>.</li>
                <li>V√° a <strong>Firestore Database</strong> > aba <strong>Regras (Rules)</strong>.</li>
                <li>Substitua o c√≥digo existente por este e clique em <strong>Publicar</strong>:</li>
            </ol>

            <div class="relative mb-6">
                <pre class="bg-slate-800 text-green-400 p-4 rounded-xl text-xs sm:text-sm font-mono overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
            </div>

            <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 border-t pt-6 border-slate-200">
                <button onclick="document.getElementById('permissionsErrorModal').classList.add('hidden')" class="w-full sm:w-auto px-6 py-3 text-slate-600 hover:bg-slate-100 font-bold rounded-xl transition-colors text-sm">
                    Continuar em Modo Local
                </button>
                <button onclick="window.location.reload()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg text-sm">
                    J√° atualizei as Regras!
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-auto">
            <div class="flex items-center gap-3 mb-4 text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-lg font-bold text-slate-800">Excluir SMS</h3>
            </div>
            <p class="text-slate-600 mb-6 text-sm">Tem a certeza que deseja excluir o SMS <span id="deleteSmsIdText" class="font-bold text-slate-800"></span>? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 font-medium rounded-lg transition-colors">Cancelar</button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold rounded-lg transition-colors">Sim, Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal de An√°lise de Similaridade -->
    <div id="similarityModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-4xl w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3 text-indigo-600">
                    <span class="text-3xl">‚ú®</span>
                    <h3 class="text-xl font-bold text-slate-800">An√°lise de Temas por IA</h3>
                </div>
                <button onclick="closeSimilarityModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="similarityDescText" class="text-slate-500 mb-6 text-sm border-b pb-4">Agrupamento inteligente dos SMS exclusivos da aba atual baseando-se no contexto das descri√ß√µes.</div>
            <div id="similarityContent" class="overflow-y-auto custom-scroll flex-1 bg-slate-50 p-6 rounded-xl border border-slate-200 text-sm text-slate-700 whitespace-pre-wrap leading-relaxed shadow-inner">
                <!-- Conte√∫do gerado pela IA aparecer√° aqui -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeSimilarityModal()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-xl transition-colors shadow-md">Fechar Relat√≥rio</button>
            </div>
        </div>
    </div>

    <!-- Modal de Plano de A√ß√£o e Resposta (IA) -->
    <div id="actionPlanModal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-3xl w-full mx-auto max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3 text-emerald-600">
                    <span class="text-3xl">‚ú®</span>
                    <h3 class="text-xl font-bold text-slate-800">Plano de A√ß√£o & Resposta</h3>
                </div>
                <button onclick="closeActionPlanModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="text-slate-500 mb-6 text-sm border-b pb-4">An√°lise de urg√™ncia, passos para resolu√ß√£o t√©cnica e rascunho de e-mail para o cliente.</div>
            <div id="actionPlanContent" class="overflow-y-auto custom-scroll flex-1 bg-slate-50 p-6 rounded-xl border border-slate-200 text-sm text-slate-700 whitespace-pre-wrap leading-relaxed shadow-inner">
                <!-- Conte√∫do gerado pela IA aparecer√° aqui -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeActionPlanModal()" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold rounded-xl transition-colors shadow-md">Concluir</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-[98%] 2xl:max-w-[1900px] mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Painel de SMS Estruturado</h1>
                <p class="text-slate-500 mt-1">Gest√£o de demandas, previs√µes e estado.</p>
                <span id="localModeWarning" class="hidden mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    Modo Local: Regras do Firebase n√£o configuradas. Os dados n√£o ser√£o salvos na nuvem.
                </span>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                    <label class="text-sm font-medium text-slate-600">Subir novo ficheiro TXT:</label>
                    <input type="file" id="fileInput" accept=".txt" class="text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o por Abas -->
        <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-200 overflow-x-auto custom-scroll">
            <button onclick="changeTab('ERP')" id="tab-ERP" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn">ERP</button>
            <button onclick="changeTab('RH')" id="tab-RH" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn">RH</button>
            <button onclick="changeTab('Log√≠stica')" id="tab-Log√≠stica" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn">Log√≠stica</button>
            <button onclick="changeTab('Jur√≠dico')" id="tab-Jur√≠dico" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn">Jur√≠dico</button>
            <button onclick="changeTab('Sa√∫de')" id="tab-Sa√∫de" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn">Sa√∫de</button>
            <button onclick="changeTab('Todos')" id="tab-Todos" class="px-6 py-3 text-slate-500 hover:text-blue-600 transition-all tab-btn tab-active">Todos</button>
        </div>

        <!-- Filtros e Estat√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6">
            <div class="md:col-span-2">
                <input type="text" id="searchInput" placeholder="Pesquisar termo ou SMS..." 
                       class="w-full h-full px-5 py-3 border border-slate-300 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
            </div>
            <div class="md:col-span-2">
                <select id="clientFilter" class="w-full h-full px-5 py-3 border border-slate-300 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-slate-700 bg-white">
                    <option value="">Filtrar por Cliente (Todos)</option>
                    <!-- Preenchido via JS -->
                </select>
            </div>
            <div class="md:col-span-1">
                <button id="btnAnalyzeThemes" onclick="analyzeSimilarities()" title="Ler SMS desta aba e agrupar por temas" class="hidden w-full h-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 px-4 py-2 rounded-xl shadow-sm font-bold flex-col items-center justify-center transition-all group">
                    <span class="text-xl group-hover:scale-110 transition-transform">‚ú®</span>
                    <span class="text-[10px] uppercase tracking-wider mt-1 text-center">Analisar Aba</span>
                </button>
            </div>
            <div class="bg-white px-5 py-3 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center items-center md:col-span-1">
                <span class="text-xs text-slate-400 uppercase font-bold tracking-wider text-center">Registos Ativos</span>
                <span id="rowCount" class="text-2xl font-bold text-blue-600">0</span>
            </div>
        </div>

        <!-- Tabela Restabelecida -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-white">
                            <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-48">Cliente</th>
                            <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider">SMS / M√≥dulo</th>
                            <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider">Descri√ß√£o / Resumo</th>
                            <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider w-44">Previs√£o de Entrega</th>
                            <th class="px-5 py-4 text-xs font-bold uppercase tracking-wider text-center w-24">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-200">
                        <!-- Sincronizado do Firestore -->
                    </tbody>
                </table>
            </div>
            <div id="noResults" class="hidden p-16 text-center">
                <p class="text-slate-400 text-lg">Nenhum registo encontrado nesta visualiza√ß√£o.</p>
                <p class="text-slate-400 text-sm mt-2">Altere os filtros ou suba um novo ficheiro .txt</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === VARI√ÅVEIS DE ESTADO E CONFIGURA√á√ÉO ===
        let db, auth, currentUser;
        let currentData = [];
        let activeTab = 'Todos';
        let pendingDeleteId = null;
        let isLocalMode = false;
        let unsubscribeSnapshot = null;

        // Configura√ß√£o Hardcoded 
        const firebaseConfig = {
            apiKey: "AIzaSyCkOgR1EAAyVTshmYHV5_L6vjaXpbEFKe0",
            authDomain: "sms-s-cdbfc.firebaseapp.com",
            projectId: "sms-s-cdbfc",
            storageBucket: "sms-s-cdbfc.firebasestorage.app",
            messagingSenderId: "935866993596",
            appId: "1:935866993596:web:db9a107d6f4911de6339b9",
            measurementId: "G-V0Z5M1CH35"
        };
        
        const appIdString = firebaseConfig.projectId;

        // === INICIALIZA√á√ÉO DA APP ===
        async function initFirebase() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Erro na autentica√ß√£o:", err);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    syncData();
                }
            });
        }
        
        initFirebase();

        // === UI References ===
        const tableBody = document.getElementById('tableBody');
        const searchInput = document.getElementById('searchInput');
        const clientFilter = document.getElementById('clientFilter');
        const rowCount = document.getElementById('rowCount');
        const noResults = document.getElementById('noResults');
        const fileInput = document.getElementById('fileInput');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const permissionsErrorModal = document.getElementById('permissionsErrorModal');

        window.enableLocalMode = () => {
            isLocalMode = true;
            document.getElementById('localModeWarning').classList.remove('hidden');
            
            // Carrega dados locais se existirem
            const saved = localStorage.getItem('sms_local_data');
            if(saved) currentData = JSON.parse(saved);
            
            updateClientDropdown();
            renderTable();
        };

        function saveLocalData() {
            if(isLocalMode) {
                localStorage.setItem('sms_local_data', JSON.stringify(currentData));
            }
        }

        // === FUN√á√ïES DE DADOS E SINCRONIZA√á√ÉO ===
        function syncData() {
            if (!currentUser || isLocalMode) return;
            
            const colRef = collection(db, 'artifacts', appIdString, 'public', 'data', 'sms_list');
            
            unsubscribeSnapshot = onSnapshot(colRef, (snapshot) => {
                currentData = snapshot.docs.map(doc => doc.data());
                updateClientDropdown();
                renderTable();
            }, (error) => {
                console.error("Erro ao ler dados:", error);
                
                // Se as regras de seguran√ßa bloquearem o acesso:
                if(error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
                   loader.style.display = 'none';
                   permissionsErrorModal.classList.remove('hidden');
                   
                   // Para de tentar for√ßar a leitura bloqueada
                   if(unsubscribeSnapshot) unsubscribeSnapshot(); 
                   
                   // Ativa imediatamente o Modo Local para a app n√£o "quebrar"
                   enableLocalMode();
                }
            });
        }

        function updateClientDropdown() {
            const currentSelection = clientFilter.value;
            const clientes = [...new Set(currentData.map(item => item.cliente))].sort();
            
            clientFilter.innerHTML = '<option value="">Filtrar por Cliente (Todos)</option>';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                clientFilter.appendChild(option);
            });
            clientFilter.value = currentSelection;
        }

        window.updateDate = async (smsId, novaData) => {
            if (isLocalMode) {
                const item = currentData.find(i => i.sms === smsId);
                if (item) item.previsao = novaData;
                saveLocalData();
                renderTable();
                return;
            }

            if (!currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appIdString, 'public', 'data', 'sms_list', smsId);
                await updateDoc(docRef, { previsao: novaData });
            } catch (err) {
                console.error("Erro ao atualizar data:", err);
                if(err.code === 'permission-denied') permissionsErrorModal.classList.remove('hidden');
            }
        };

        window.openDeleteModal = (smsId) => {
            pendingDeleteId = smsId;
            document.getElementById('deleteSmsIdText').textContent = smsId;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            pendingDeleteId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        };

        window.confirmDelete = async () => {
            if (!pendingDeleteId) return;

            if (isLocalMode) {
                currentData = currentData.filter(i => i.sms !== pendingDeleteId);
                saveLocalData();
                closeDeleteModal();
                renderTable();
                return;
            }

            if (!currentUser) return;
            try {
                const docRef = doc(db, 'artifacts', appIdString, 'public', 'data', 'sms_list', pendingDeleteId);
                await deleteDoc(docRef);
                closeDeleteModal();
            } catch (err) {
                console.error("Erro ao excluir SMS:", err);
                closeDeleteModal();
                if(err.code === 'permission-denied') permissionsErrorModal.classList.remove('hidden');
            }
        };

        // === Fun√ß√£o da IA (Gemini) ===
        
        async function getGeminiKey() {
            return "AIzaSyC7aKk1Eeqs17H1bUbkcRjEytC1p0GQeaM";
        }
        
        async function fetchWithBackoff(url, options, retries = 3) {
            const delays = [1000, 2000, 4000]; // Reduzido para evitar longas demoras
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    return await response.json();
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(res => setTimeout(res, delays[i]));
                }
            }
        }

        window.generateAISummary = async (smsId) => {
            if (!currentUser && !isLocalMode) return;
            
            const apiKey = await getGeminiKey();
            if (apiKey === null) return;

            const item = currentData.find(i => i.sms === smsId);
            if (!item || !item.descricao) return;

            loaderText.textContent = "A IA est√° a analisar o pedido...";
            loader.style.display = 'flex';

            // Limitamos a descri√ß√£o a 2000 caracteres para evitar ultrapassar limites
            const safeDesc = item.descricao.length > 2000 ? item.descricao.substring(0, 2000) + "... [truncado]" : item.descricao;

            const prompt = `Voc√™ √© um especialista em suporte de TI e sistemas corporativos. Leia a descri√ß√£o t√©cnica a seguir e crie um resumo ultra-curto, direto e muito claro (de 5 a 12 palavras no m√°ximo) informando qual √© o problema ou a solicita√ß√£o principal:\n\nDescri√ß√£o: ${safeDesc}`;

            try {
                const result = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    }
                );

                const aiSummary = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (aiSummary) {
                    if (isLocalMode) {
                        item.resumo = `‚ú® IA: ${aiSummary}`;
                        saveLocalData();
                        renderTable();
                    } else {
                        const docRef = doc(db, 'artifacts', appIdString, 'public', 'data', 'sms_list', smsId);
                        await updateDoc(docRef, { resumo: `‚ú® IA: ${aiSummary}` });
                    }
                }
            } catch (err) {
                console.error("Erro Gemini:", err);
                if (err.message.includes('400') || err.message.includes('403')) {
                    alert("A sua API Key do Gemini parece ser inv√°lida ou n√£o tem permiss√µes.");
                } else if (err.message.includes('429')) {
                    alert("Limite de utiliza√ß√£o da API atingido. Aguarde um minuto e tente de novo.");
                } else {
                    alert(`Falha na IA (${err.message}). O texto pode ser demasiado longo.`);
                }
            } finally {
                loader.style.display = 'none';
                loaderText.textContent = "A processar...";
            }
        };

        // === An√°lise de Similaridades por Tema ===
        window.openSimilarityModal = () => {
            document.getElementById('similarityModal').classList.remove('hidden');
        };

        window.closeSimilarityModal = () => {
            document.getElementById('similarityModal').classList.add('hidden');
        };

        window.openActionPlanModal = () => {
            document.getElementById('actionPlanModal').classList.remove('hidden');
        };

        window.closeActionPlanModal = () => {
            document.getElementById('actionPlanModal').classList.add('hidden');
        };

        window.generateActionPlan = async (smsId) => {
            if (!currentUser && !isLocalMode) return;
            
            const apiKey = await getGeminiKey();
            if (apiKey === null) return;

            const item = currentData.find(i => i.sms === smsId);
            if (!item || !item.descricao) return;

            loaderText.textContent = "‚ú® A criar plano de a√ß√£o e resposta...";
            loader.style.display = 'flex';

            // Limitar tamb√©m para o plano de a√ß√£o
            const safeDesc = item.descricao.length > 2500 ? item.descricao.substring(0, 2500) + "... [truncado]" : item.descricao;

            const prompt = `Atue como um Engenheiro de Suporte de TI S√©nior. Analise o seguinte chamado do cliente '${item.cliente}':
Descri√ß√£o: ${safeDesc}

Forne√ßa a sua resposta EXATAMENTE no seguinte formato Markdown:

## üö® N√≠vel de Urg√™ncia
[Avalie como Baixa, M√©dia, Alta ou Cr√≠tica e justifique em 1 frase]

## üõ†Ô∏è Plano de A√ß√£o T√©cnico
[Liste de 2 a 4 passos pr√°ticos e t√©cnicos que a equipa de suporte/desenvolvimento deve executar para investigar ou resolver este problema]

## ‚úâÔ∏è Rascunho de Resposta ao Cliente
[Escreva um e-mail profissional, educado e emp√°tico (em portugu√™s de Portugal ou do Brasil, conforme o contexto), informando o cliente que o problema est√° a ser tratado ou dando uma orienta√ß√£o inicial. Deixe espa√ßos como [Seu Nome] para preenchimento posterior.]`;

            try {
                const result = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    }
                );

                let aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                if (aiResponse) {
                    aiResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900">$1</strong>');
                    aiResponse = aiResponse.replace(/\*(.*?)\*/g, '<em class="text-slate-800">$1</em>');
                    aiResponse = aiResponse.replace(/## (.*?)\n/g, '<h2 class="text-lg font-extrabold text-emerald-700 mt-5 mb-2 bg-emerald-50 px-3 py-1.5 rounded inline-block">$1</h2>\n');
                    aiResponse = aiResponse.replace(/\n\n/g, '<br><br>');
                    
                    document.getElementById('actionPlanContent').innerHTML = aiResponse;
                    openActionPlanModal();
                }
            } catch (err) {
                console.error("Erro Gemini:", err);
                if (err.message.includes('400') || err.message.includes('403')) {
                    alert("A sua API Key parece ser inv√°lida ou estar bloqueada.");
                } else if (err.message.includes('429')) {
                    alert("Muitos pedidos enviados √† IA ao mesmo tempo. Por favor, aguarde um bocado.");
                } else {
                    alert(`Falha na IA (${err.message}). O texto pode ser demasiado pesado para ser processado.`);
                }
            } finally {
                loader.style.display = 'none';
                loaderText.textContent = "A processar...";
            }
        };

        window.analyzeSimilarities = async () => {
            if (!currentUser && !isLocalMode) return;
            
            if (activeTab === 'Todos') {
                alert("A an√°lise por IA est√° dispon√≠vel apenas dentro de uma aba espec√≠fica (ERP, RH, etc). Selecione uma aba primeiro.");
                return;
            }

            const smsDaAbaTotal = currentData.filter(i => i.modulo === activeTab);

            if (smsDaAbaTotal.length === 0) {
                alert(`N√£o existem SMS na aba ${activeTab} para analisar. Suba um ficheiro primeiro.`);
                return;
            }

            const apiKey = await getGeminiKey();
            if (apiKey === null) return;

            loader.style.display = 'flex';

            // NOVO SISTEMA EM LOTES (SEM LIMITE M√ÅXIMO DE SMS)
            // Divide as SMS em pacotes para n√£o estoirar os limites de mem√≥ria da API
            const BATCH_SIZE = 50; 
            const totalBatches = Math.ceil(smsDaAbaTotal.length / BATCH_SIZE);
            let finalAiResponse = "";

            for (let currentBatch = 0; currentBatch < totalBatches; currentBatch++) {
                loaderText.textContent = `A analisar SMS da aba ${activeTab} (Lote ${currentBatch + 1} de ${totalBatches})... Isto pode demorar.`;

                const batchData = smsDaAbaTotal.slice(currentBatch * BATCH_SIZE, (currentBatch + 1) * BATCH_SIZE);
                
                let smsListText = `\n\n=== M√ìDULO/PRODUTO: ${activeTab.toUpperCase()} (PARTE ${currentBatch + 1} de ${totalBatches}) ===\n`;
                smsListText += batchData.map(i => {
                    // Limitamos levemente a descri√ß√£o individual para evitar falhas de tamanho, mas enviamos TODAS as SMS
                    const descSegura = i.descricao.length > 1500 
                        ? i.descricao.substring(0, 1500) + "... [texto longo truncado]" 
                        : i.descricao;
                    return `[SMS: ${i.sms} | Cliente: ${i.cliente}]\nDescri√ß√£o: ${descSegura}`;
                }).join("\n\n---\n\n");
                
                const prompt = `Atue como um Especialista em Suporte de TI e An√°lise de Requisitos de Software.
Abaixo est√£o as SMS referentes ao m√≥dulo/produto '${activeTab}'.
A sua tarefa √© ler este grupo e procurar similaridades, agrupando as SMS por temas, funcionalidades ou problemas recorrentes.

Regras OBRIGAT√ìRIAS:
1. Comece com um cabe√ßalho '## Resumo Anal√≠tico - ${activeTab} (Lote ${currentBatch + 1})'.
2. Crie subgrupos por Temas de similaridade (ex: '### Lentid√£o no Sistema', '### D√∫vidas Financeiras').
3. Forne√ßa uma breve explica√ß√£o de 1 a 2 linhas sobre o que aquele tema aborda.
4. Liste os n√∫meros de SMS exatos que pertencem a esse grupo e o respetivo Cliente afetado.
5. Formate a resposta usando Markdown de forma limpa, f√°cil de ler e muito profissional.

Aqui est√£o os dados deste lote:
${smsListText}`;

                try {
                    const result = await fetchWithBackoff(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }]
                            })
                        }
                    );

                    let responseText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    if (responseText) {
                        finalAiResponse += responseText + "\n\n<hr class='my-8 border-slate-300'>\n\n";
                    }
                } catch (err) {
                    console.error("Erro Gemini Lote", currentBatch, err);
                    finalAiResponse += `\n\n**[Aviso: Falha t√©cnica ao analisar o Lote ${currentBatch + 1}. A API rejeitou o pedido.]**\n\n`;
                }

                // Pausa de 3 segundos entre chamadas para n√£o sofrer bloqueio de Taxa de Requisi√ß√£o (Erro 429) do Google
                if (currentBatch < totalBatches - 1) {
                    loaderText.textContent = `A processar... aguardando intervalo de seguran√ßa da API...`;
                    await new Promise(res => setTimeout(res, 3000));
                }
            }

            loader.style.display = 'none';

            if (finalAiResponse) {
                let htmlFormat = finalAiResponse;
                htmlFormat = htmlFormat.replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-900">$1</strong>');
                htmlFormat = htmlFormat.replace(/\*(.*?)\*/g, '<em class="text-slate-800">$1</em>');
                htmlFormat = htmlFormat.replace(/### (.*?)\n/g, '<h3 class="text-lg font-bold text-slate-800 mt-5 mb-2 border-b pb-1">$1</h3>\n');
                htmlFormat = htmlFormat.replace(/## (.*?)\n/g, '<h2 class="text-xl font-extrabold text-indigo-700 mt-6 mb-3 bg-indigo-50 px-3 py-2 rounded-lg inline-block">$1</h2>\n');
                htmlFormat = htmlFormat.replace(/\n\n/g, '<br><br>');
                
                document.getElementById('similarityDescText').innerHTML = `Agrupamento de <strong>todas as ${smsDaAbaTotal.length} SMS</strong> da aba selecionada, processadas e combinadas a partir de ${totalBatches} lote(s).`;
                document.getElementById('similarityContent').innerHTML = htmlFormat;
                openSimilarityModal();
            } else {
                alert("N√£o foi poss√≠vel gerar a an√°lise completa. Verifique a sua liga√ß√£o ou os limites da sua API Key.");
            }
        };

        function categorizar(texto) {
            const t = texto.toLowerCase();
            if (t.includes('contrato') || t.includes('juridico') || t.includes('al√ßada') || t.includes('legal')) return 'Jur√≠dico';
            if (t.includes('pagamento') || t.includes('compra') || t.includes('contabil') || t.includes('fiscal') || t.includes('faturamento')) return 'ERP';
            if (t.includes('funcionario') || t.includes('folha') || t.includes('ponto') || t.includes('rh') || t.includes('beneficio')) return 'RH';
            if (t.includes('entrega') || t.includes('estoque') || t.includes('logistica') || t.includes('transporte')) return 'Log√≠stica';
            if (t.includes('medico') || t.includes('paciente') || t.includes('prontuario') || t.includes('saude') || t.includes('hospit')) return 'Sa√∫de';
            return 'ERP'; // Padr√£o
        }

        async function uploadData(dataArray) {
            loader.style.display = 'flex';
            
            if (isLocalMode) {
                dataArray.forEach(newItem => {
                    const index = currentData.findIndex(i => i.sms === newItem.sms);
                    if(index > -1) {
                        const oldPrevisao = currentData[index].previsao;
                        currentData[index] = { ...currentData[index], ...newItem };
                        if(oldPrevisao) currentData[index].previsao = oldPrevisao;
                    } else {
                        currentData.push(newItem);
                    }
                });
                saveLocalData();
                updateClientDropdown();
                renderTable();
                loader.style.display = 'none';
                return;
            }

            if (!currentUser) {
                loader.style.display = 'none';
                return;
            }
            
            try {
                for (const item of dataArray) {
                    const docRef = doc(db, 'artifacts', appIdString, 'public', 'data', 'sms_list', item.sms);
                    await setDoc(docRef, item, { merge: true });
                }
            } catch (err) {
                console.error("Erro ao salvar:", err);
                if(err.code === 'permission-denied') permissionsErrorModal.classList.remove('hidden');
            } finally {
                loader.style.display = 'none';
            }
        }

        function parseText(text) {
            // Remove o cabe√ßalho se ele existir
            let cleanText = text.replace(/^CLIENTE¬¨SMS¬¨DESCRICAO¬¨RESUMO¬¨\r?\n?/, '');
            
            // O separador nativo do ficheiro que forneceu √© o '¬¨'
            const parts = cleanText.split('¬¨');
            const dataArray = [];
            
            // Processa as colunas de 4 em 4
            for (let i = 0; i < parts.length - 3; i += 4) {
                const c = parts[i]?.trim();
                const s = parts[i+1]?.trim();
                const d = parts[i+2]?.trim();
                const r = parts[i+3]?.trim();
                
                // Valida√ß√£o de seguran√ßa: 
                // O campo SMS deve existir, ter menos de 50 caracteres e n√£o deve conter barras '/'
                // Isto previne falhas no Firestore em caso de desalinhamento de linhas.
                if (c && s && s.length < 50 && !s.includes('/')) {
                    dataArray.push({
                        cliente: c,
                        sms: s,
                        descricao: d,
                        resumo: r,
                        modulo: categorizar(d + " " + r),
                        timestamp: Date.now()
                    });
                }
            }
            return dataArray;
        }

        // === EVENTOS DA INTERFACE ===
        window.changeTab = (tab) => {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('tab-active');
                if (b.id === `tab-${tab}`) b.classList.add('tab-active');
            });
            
            const btnAnalyze = document.getElementById('btnAnalyzeThemes');
            if (activeTab === 'Todos') {
                btnAnalyze.classList.add('hidden');
                btnAnalyze.classList.remove('flex');
            } else {
                btnAnalyze.classList.remove('hidden');
                btnAnalyze.classList.add('flex');
            }
            
            renderTable();
        };

        function renderTable() {
            if (!tableBody) return; // Seguran√ßa extra

            tableBody.innerHTML = '';
            
            const searchTerm = searchInput.value.toLowerCase();
            const clientTerm = clientFilter.value;

            let filtered = activeTab !== 'Todos' 
                ? currentData.filter(i => i.modulo === activeTab) 
                : currentData;

            if (clientTerm) {
                filtered = filtered.filter(i => i.cliente === clientTerm);
            }

            if (searchTerm) {
                filtered = filtered.filter(i => 
                    i.cliente.toLowerCase().includes(searchTerm) ||
                    i.sms.toLowerCase().includes(searchTerm) ||
                    i.descricao.toLowerCase().includes(searchTerm) ||
                    i.resumo.toLowerCase().includes(searchTerm)
                );
            }

            rowCount.textContent = filtered.length;

            if (filtered.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
                
                filtered.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition-colors";
                    
                    const dataPrevisao = item.previsao ? item.previsao : '';

                    tr.innerHTML = `
                        <td class="px-5 py-4 text-sm font-bold text-slate-700 align-top">${item.cliente}</td>
                        <td class="px-5 py-4 text-sm align-top">
                            <span class="sms-badge">${item.sms}</span>
                            <div class="mt-2"><span class="text-[10px] px-2 py-0.5 rounded bg-slate-200 text-slate-600 font-bold uppercase tracking-wider">${item.modulo}</span></div>
                        </td>
                        <td class="px-5 py-4 align-top">
                            <div class="text-sm font-semibold text-slate-800 mb-1">${item.resumo}</div>
                            <div class="text-xs text-slate-500 description-cell">${item.descricao}</div>
                        </td>
                        <td class="px-5 py-4 align-top">
                            <input type="date" value="${dataPrevisao}" onchange="updateDate('${item.sms}', this.value)" 
                                   class="w-full text-sm p-2 border border-slate-300 rounded-lg text-slate-700 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 bg-white transition-all cursor-pointer">
                        </td>
                        <td class="px-5 py-4 align-top text-center">
                            <div class="flex items-center justify-center gap-1 flex-wrap">
                                <button onclick="generateAISummary('${item.sms}')" title="Resumir com IA (Gemini)" class="text-indigo-500 hover:text-indigo-700 hover:bg-indigo-50 p-2 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>
                                    </svg>
                                </button>
                                <button onclick="generateActionPlan('${item.sms}')" title="Gerar Plano de A√ß√£o e Resposta (IA)" class="text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 p-2 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                                        <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                        <path d="M9 14h6"></path>
                                        <path d="M9 18h6"></path>
                                        <path d="M9 10h6"></path>
                                    </svg>
                                </button>
                                <button onclick="openDeleteModal('${item.sms}')" title="Excluir SMS" class="text-slate-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }
        }

        // Listeners
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const data = parseText(ev.target.result);
                await uploadData(data);
                fileInput.value = "";
            };
            reader.readAsText(file);
        });

        searchInput.addEventListener('input', renderTable);
        clientFilter.addEventListener('change', renderTable);

    </script>
</body>
</html>
